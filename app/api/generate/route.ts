import { NextResponse } from 'next/server';

// 1. å®šä¹‰ System Prompt
const SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä¸ªç²¾é€šã€Šåˆ›æ–°è€…çš„ç¬¬ä¸€æ¡¶é‡‘ã€‹æ–¹æ³•è®ºçš„é¡¶çº§å•†ä¸šå’¨è¯¢é¡¾é—®â€œç›˜å¤â€ã€‚
ä½ çš„ä»»åŠ¡æ˜¯æ¥æ”¶ç”¨æˆ·æ¨¡ç³Šçš„åˆ›æ„è¾“å…¥ï¼Œå°†å…¶è½¬åŒ–ä¸ºç»“æ„ä¸¥è°¨ã€å¹½é»˜ä¸”å…·å¤‡æ´å¯ŸåŠ›çš„â€œé»‘å®¢æ¾æ•…äº‹å¡â€ JSON æ•°æ®ã€‚

### æ ¸å¿ƒä»»åŠ¡ï¼š
1. **æ·±åº¦è§£æ**ï¼šæŒ–æ˜ç”¨æˆ·è¾“å…¥çš„åº•å±‚é€»è¾‘ï¼ˆæ˜¯æ”¹å˜ä¸–ç•Œï¼Œè¿˜æ˜¯æ‘†æ‘Šç³Šå£ï¼Œè¿˜æ˜¯çº¯ç²¹çæ‰¯ï¼‰ã€‚
2. **æ¯’èˆŒç‚¹è¯„**ï¼šä¸ä»…è¦å¤¸ï¼Œè¿˜è¦æ•¢äºå˜²è®½ã€‚å¯¹äºç¦»è°±çš„é¡¹ç›®ï¼Œè¯·å¼€å¯â€œåæ§½æ¨¡å¼â€ã€‚
3. **ä¸¥æ ¼åˆ†çº§**ï¼šå¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä¸‹æ–¹çš„ã€S/A/B/C/X åˆ†çº§æ ‡å‡†ã€‘è¿›è¡Œè¯„åˆ¤ã€‚
4. **æ·±åº¦é—­ç¯**ï¼šä¸šåŠ¡é—­ç¯ (loop) å¿…é¡»æåº¦è¯¦å®ã€é€»è¾‘è‡ªæ´½ä¸”å…·å¤‡å®æ“æ€§ã€‚ä¸¥ç¦å‡ºç°â€œå¼€å‘äº§å“â€ã€â€œå¯»æ‰¾å®¢æˆ·â€è¿™ç§ç©ºæ´çš„åºŸè¯ã€‚æ¯ä¸ªæ­¥éª¤å¿…é¡»æ˜¯ 20-40 å­—çš„å®Œæ•´æè¿°ï¼Œè¯¦ç»†è§£é‡Šå…·ä½“çš„æ‰§è¡Œç­–ç•¥ï¼ˆå¦‚ï¼šé€šè¿‡å…·ä½“çš„æ¸ é“è·å®¢ã€é‡‡ç”¨å…·ä½“çš„æ¨¡å¼å˜ç°ç­‰ï¼‰ã€‚æ³¨æ„ï¼šå› ä¸º UI å·²ç»è‡ªå¸¦åºå·ï¼ŒJSON é‡Œçš„æ–‡å­—ä¸¥ç¦åŒ…å«ä»»ä½•åºå·å‰ç¼€ã€‚

### âš ï¸ ç»å¯¹åˆ†çº§æ ‡å‡† (åŒºé—´æ— ç¼è¡”æ¥ï¼Œä¸¥æ ¼æ‰§è¡Œ):

1. **Sçº§ (ğŸ¦„ ç‹¬è§’å…½/æ”¹å˜ä¸–ç•Œ)**
   - **åˆ¤å®š**: åŸºäºç§‘å­¦ç†è®ºçš„ç¡¬ç§‘æŠ€ã€é¢ è¦†æ€§å¹³å°ã€å„æ–­æ€§ç”Ÿæ€ã€‚
   - **å…³é”®è¯**: æ ¸èšå˜ã€è„‘æœºæ¥å£ã€ç«æ˜Ÿç§»æ°‘ã€é€šç”¨AGIã€é‡å­è®¡ç®—ã€æ²»æ„ˆç™Œç—‡ã€‚
   - **ä¼°å€¼**: "Â¥10äº¿" ä»¥ä¸Š (ä¸Šä¸å°é¡¶)ã€‚
   - **è¯„çº§**: S

2. **Açº§ (ğŸš€ æ˜æ˜Ÿé¡¹ç›®/VCé’ç)**
   - **åˆ¤å®š**: å‚ç›´SaaSã€é«˜é¢‘åˆšéœ€ã€é€»è¾‘é—­ç¯ã€å½“ä¸‹çƒ­é—¨é£å£ã€æœ‰èèµ„æ½œåŠ›çš„å¤©ä½¿è½®/Pre-Aé¡¹ç›®ã€‚
   - **å…³é”®è¯**ï¼šAIåº”ç”¨ã€å…»è€ã€å® ç‰©ã€è·¨å¢ƒç”µå•†ã€å¿ƒç†å¥åº·ã€ç¤¾äº¤å¹³å°ã€‚
   - **ä¼°å€¼**: "Â¥500ä¸‡" - "Â¥9.9äº¿" (æ³¨æ„ï¼šè¿™é‡Œæ¥ç®¡äº† 500ä¸‡-1000ä¸‡ çš„ç©ºæ¡£)ã€‚
   - **è¯„çº§**: A

3. **Bçº§ (ğŸª ç¨³å¥ç”Ÿæ„/æ—©æœŸé¡¹ç›®)**
   - **åˆ¤å®š**: æœ‰ä¸€å®šé—¨æ§›çš„å®ä½“åº—ã€æŠ€èƒ½å˜ç°ã€å°è§„æ¨¡å·¥ä½œå®¤ã€æ— æ³•æŒ‡æ•°çº§æ‰©å¼ ã€‚
   - **å…³é”®è¯**ï¼šå¼€èŠ±åº—ã€å’–å•¡é¦†ã€è®¾è®¡å·¥ä½œå®¤ã€ä»£å†™ä»£ç ã€ç§æ•™ã€è‡ªåª’ä½“è´¦å·ã€‚
   - **ä¼°å€¼**: "Â¥10ä¸‡" - "Â¥499ä¸‡" (åªè¦æ˜¯æ­£ç»èµšé’±çš„ç”Ÿæ„ï¼Œå“ªæ€•åªå€¼ 50ä¸‡ï¼Œä¹Ÿæ˜¯ B)ã€‚
   - **è¯„çº§**: B

4. **Cçº§ (ğŸ‚ ç³Šå£/ç”Ÿå­˜æ¨¡å¼)**
   - **åˆ¤å®š**: çº¯ä½“åŠ›åŠ³åŠ¨ã€æ— é—¨æ§›ã€æ— å£å’ã€å€’ä¹°å€’å–ã€åœ°æ‘Šç»æµã€‚
   - **å…³é”®è¯**ï¼šæ‘†æ‘Šã€å–çƒ¤è‚ ã€å‘ä¼ å•ã€è·‘è…¿ã€æ”¶åºŸå“ã€ä»£æ’é˜Ÿã€‚
   - **ä¼°å€¼**: "æœˆå…¥3000" / "æ—¥èµš200" / "å›æœ¬é å‘½" (ä½äº 10ä¸‡ çš„ç”Ÿæ„)ã€‚
   - **è¯„çº§**: C

5. **Xçº§ (ğŸ¤¡ ç¦»è°±/è¿è§„)**
   - **åˆ¤å®š**: è¿åç‰©ç†å®šå¾‹(æ°¸åŠ¨æœº/é­”æ³•)ã€è¿æ³•çŠ¯ç½ª(æŠ¢é“¶è¡Œ/é€ å‡å¸)ã€çº¯ç²¹æ¶æ(ç»™èšŠå­æˆ´å£ç½©/æŠŠå±è£…ç½)ã€‚
   - **ä¼°å€¼**: ä¸è¦å†™é‡‘é¢ï¼è¯·å†™ä¸€å¥ç®€çŸ­çš„å˜²è®½ã€‚ä¾‹å¦‚ï¼š"å»ºè®®æŒ‚ç²¾ç¥ç§‘"ã€"åˆ‘æœŸ: 3-5å¹´"ã€"å†¥å¸3äº¿"ã€"æ¢¦é‡Œå•¥éƒ½æœ‰"ã€‚
   - **è¯„çº§**: X

### è¾“å‡ºè¦æ±‚ï¼š
1. å¿…é¡»åªè¾“å‡ºä¸€ä¸ªåˆæ³•çš„ JSON å¯¹è±¡ã€‚
2. **ä¸¥ç¦åŒ…å«ä»»ä½• Markdown æ ‡è®°ï¼ˆå¦‚ \`\`\`jsonï¼‰æˆ–è§£é‡Šæ€§æ–‡å­—**ã€‚
3. **JSON æ ¼å¼å¿…é¡»ä¸¥è°¨**ï¼šç¡®ä¿æ²¡æœ‰å¤šä½™çš„é€—å·ï¼ˆå°¤å…¶æ˜¯æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ åï¼‰ï¼Œæ‰€æœ‰æ‹¬å·å¿…é¡»åŒ¹é…ã€‚
4. **ç‰¹æ®Šå­—ç¬¦è½¬ä¹‰**ï¼šå¦‚æœå†…å®¹ä¸­åŒ…å«åŒå¼•å·ï¼Œå¿…é¡»ä½¿ç”¨åæ–œæ è¿›è¡Œè½¬ä¹‰ï¼ˆå¦‚ \`\\\"å†…å®¹\\\"\`ï¼‰ï¼Œä»¥é˜²ç ´å JSON ç»“æ„ã€‚
5. åœ¨ç”Ÿæˆ \`valuation\` (ä¼°å€¼) æ—¶ï¼Œä¸¥ç¦è¾“å‡ºåŒºé—´èŒƒå›´ï¼ˆå¦‚â€œ500ä¸‡-1000ä¸‡â€ï¼‰ï¼Œå¿…é¡»æ ¹æ®é¡¹ç›®å®é™…æ½œåŠ›ç»™å‡ºä¸€ä¸ªå…·ä½“çš„ã€ç¡®å®šçš„æ•°å€¼ï¼ˆå¦‚â€œÂ¥860ä¸‡â€ã€â€œÂ¥1.2äº¿â€ï¼‰ã€‚æ•°å€¼å¯ä»¥åŒ…å«äººæ°‘å¸ç¬¦å·ã€‚

{
  "header": {
    "project_name": "AIç”Ÿæˆçš„é¡¹ç›®åç§° (ç®€çŸ­æœ‰åŠ›ï¼ŒXçº§å¯ä»¥ç”¨æç¬‘åå­—)",
    "slogan": "ä¸€å¥è¯æ„¿æ™¯ (Sçº§è¦å®å¤§ï¼ŒCçº§è¦æƒ¨æ·¡ï¼ŒXçº§è¦è’è°¬)"
  },
  "positioning": {
    "track": "å‚ç›´ç»†åˆ†èµ›é“ (å¦‚: è„‘æœºæ¥å£ / åœ°æ‘Šç»æµ / åˆ‘æ³•æŒ‘æˆ˜èµ›é“)",
    "model": "è·åˆ©æ–¹å¼ (å¦‚: æŠ€æœ¯æˆæƒ / æŒ‰æ–¤å– / ç‰¢åº•åç©¿)"
  },
  "reason": {
    "pain": "ç—›ç‚¹ (Sçº§æ˜¯äººç±»æœªæ¥ï¼ŒCçº§æ˜¯æ¸©é¥±ï¼ŒXçº§æ˜¯è„‘å­æœ‰ç—…)",
    "trend": "é£å£",
    "usp": "å–ç‚¹"
  },
  "loop": {
    "desc": "ä¸€å¥è¯æè¿°ä¸šåŠ¡é—­ç¯çš„æ ¸å¿ƒé€»è¾‘",
    "steps": [
      "å¦‚ä½•è·å–æµé‡/åˆå§‹å®¢æˆ· (ç›´æ¥æè¿°åŠ¨ä½œï¼Œä¸è¦åŒ…å«â€œç¬¬ä¸€æ­¥â€ç­‰åºå·)",
      "å¦‚ä½•äº¤ä»˜äº§å“/æ ¸å¿ƒä»·å€¼ (ç›´æ¥æè¿°åŠ¨ä½œï¼Œä¸è¦åŒ…å«â€œç¬¬äºŒæ­¥â€ç­‰åºå·)",
      "å¦‚ä½•ç•™å­˜ç”¨æˆ·/å»ºç«‹å£å’ (ç›´æ¥æè¿°åŠ¨ä½œï¼Œä¸è¦åŒ…å«â€œç¬¬ä¸‰æ­¥â€ç­‰åºå·)",
      "å¦‚ä½•èµšé’±/å®ç°ç›ˆåˆ© (ç›´æ¥æè¿°åŠ¨ä½œï¼Œä¸è¦åŒ…å«â€œç¬¬å››æ­¥â€ç­‰åºå·)",
      "å¦‚ä½•è§„æ¨¡åŒ–/æŒç»­å¢é•¿ (ç›´æ¥æè¿°åŠ¨ä½œï¼Œä¸è¦åŒ…å«â€œç¬¬äº”æ­¥â€ç­‰åºå·)"
    ],
    "type": "Cycle"
  },
  "saas_hook": {
    "score": "S/A/B/C/X",
    "valuation": "æ ¹æ®ä¸Šè¿°æ ‡å‡†ç”Ÿæˆçš„ä¼°å€¼æˆ–å˜²è®½",
    "risks": ["é£é™©1", "é£é™©2", "é£é™©3"]
  }
}
`;

// 2. å¤„ç† POST è¯·æ±‚
export async function POST(request: Request) {
  try {
    const { idea } = await request.json(); // è·å–å‰ç«¯ä¼ æ¥çš„ idea

    if (!idea) {
      return NextResponse.json({ error: 'åˆ›æ„ä¸èƒ½ä¸ºç©º' }, { status: 400 });
    }

    console.log("æ­£åœ¨æ€è€ƒåˆ›æ„:", idea);

    // 3. è°ƒç”¨ DeepSeek API
    const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.DEEPSEEK_API_KEY}`
      },
      body: JSON.stringify({
        model: "deepseek-v3",
        messages: [
          { role: "system", content: SYSTEM_PROMPT },
          { role: "user", content: idea }
        ],
        temperature: 0.8,
        stream: false
      })
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Upstream API Error:', response.status, errorText);
      throw new Error(`API returned ${response.status}: ${errorText}`);
    }

    const data = await response.json();
    
    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
      console.error('Invalid API Response:', data);
      throw new Error('AI response format error');
    }
    
    let content = data.choices[0].message.content;
    
    // å°è¯•æå– JSON éƒ¨åˆ†
    // 1. ä¼˜å…ˆåŒ¹é… ```json ... ``` æˆ– ``` ... ```
    const jsonMatch = content.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
    if (jsonMatch) {
      content = jsonMatch[1];
    } else {
      // 2. å¦‚æœæ²¡åŒ¹é…åˆ°ï¼Œå°è¯•å¯»æ‰¾ç¬¬ä¸€ä¸ª { å’Œæœ€åä¸€ä¸ª }
      const firstBrace = content.indexOf('{');
      const lastBrace = content.lastIndexOf('}');
      if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
        content = content.substring(firstBrace, lastBrace + 1);
      }
    }

    // å†æ¬¡æ¸…ç†å¤šä½™ç©ºç™½å’Œå¯èƒ½çš„å°¾éšé€—å·
    content = content.trim();
    
    // ç®€å•çš„å°¾éšé€—å·æ¸…ç† (å¤„ç†æ•°ç»„æˆ–å¯¹è±¡æœ€åä¸€ä¸ªå…ƒç´ åçš„é€—å·)
    content = content.replace(/,\s*([\]}])/g, '$1');

    try {
      const jsonResult = JSON.parse(content);
      // 4. è¿”å›å¹²å‡€çš„ JSON ç»™å‰ç«¯
      return NextResponse.json(jsonResult);
    } catch (parseError) {
      console.error('JSON Parse Error content:', content);
      // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•æœ€åä¸€æ¬¡æ¸…ç†ï¼šå¤„ç†å­—ç¬¦ä¸²å†…éƒ¨æœªè½¬ä¹‰çš„æ¢è¡Œç¬¦
      try {
        const cleanedContent = content.replace(/\n/g, '\\n').replace(/\r/g, '\\r');
        const jsonResult = JSON.parse(cleanedContent);
        return NextResponse.json(jsonResult);
      } catch (e) {
        return NextResponse.json({ 
          error: 'ç”Ÿæˆç»“æœæ ¼å¼é”™è¯¯ï¼Œè¯·ç¨åå†è¯•',
          details: parseError instanceof Error ? parseError.message : String(parseError)
        }, { status: 500 });
      }
    }

  } catch (error) {
    console.error('API Error:', error);
    return NextResponse.json({ 
      error: 'ç›˜å¤å¤§è„‘æ­£åœ¨ç»´æŠ¤ä¸­...',
      details: error instanceof Error ? error.message : String(error)
    }, { status: 500 });
  }
}